<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Scout - Fixed Speed | htmlãƒãƒ³</title>
    <style>
        :root { --primary: #0a2e5c; --accent: #e63946; --bg: #f0f2f5; --success: #2b9348; --undo: #f39c12; --danger: #d90429; --share: #00b900; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { margin: 0; padding: 4px; height: 100vh; width: 100vw; overflow: hidden; background: var(--bg); display: flex; flex-direction: column; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 8px 12px; border-radius: 8px; margin-bottom: 4px; z-index: 10; }
        .header h1 { font-size: 0.9rem; margin: 0; font-weight: bold; }
        .btn-settings { background: #fff; border: none; color: var(--primary); padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .main-layout { flex: 1; display: flex; flex-direction: column; min-height: 0; gap: 4px; }

        /* ã‚¾ãƒ¼ãƒ³è¡¨ç¤º */
        .map-area { flex: 1.4; display: flex; justify-content: center; align-items: center; position: relative; min-height: 0; }
        #canvas-wrap { position: relative; height: 98%; aspect-ratio: 3 / 3.6; background: #333; border: 3px solid #111; border-radius: 10px; touch-action: none; }
        #s-zone { position: absolute; top: 22%; left: 21%; width: 58%; height: 56%; border: 1.5px solid rgba(255,255,255,0.4); pointer-events: none; }
        canvas#h-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .dot { position: absolute; width: 14px; height: 14px; border-radius: 50%; transform: translate(-50%, -50%); border: 1.5px solid #fff; pointer-events: none; z-index: 5; }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        .ctrl-panel { flex: 0 0 auto; background: #fff; padding: 8px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* çƒé€Ÿã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆã“ã“ãŒæ¶ˆãˆã¦ã„ãŸã®ã§ç¢ºå®Ÿã«è¡¨ç¤ºï¼‰ */
        .speed-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background: #fff9c4; padding: 10px; border-radius: 8px; border: 1px solid #fbc02d; }
        .speed-txt { font-size: 1.1rem; font-weight: bold; color: var(--accent); min-width: 90px; }
        #sp-sld { flex: 1; height: 30px; cursor: pointer; }

        /* 3x3ãƒœã‚¿ãƒ³ */
        .compass { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .p-btn { width: 100%; aspect-ratio: 1.8/1; border: 2px solid #ddd; border-radius: 8px; background: #fff; font-size: 0.9rem; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; }
        .p-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .p-btn.hidden { visibility: hidden; pointer-events: none; }
        .p-btn span { font-size: 0.55rem; margin-top: 2px; }

        /* ä¸‹éƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
        .action-row { display: grid; grid-template-columns: 1fr 2fr; gap: 8px; margin-top: 8px; }
        .btn-main { padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: #fff; font-size: 1rem; }
        .b-undo { background: var(--undo); }
        .b-rep { background: var(--success); }

        /* å±¥æ­´ï¼ˆãƒ¢ãƒã‚¯ãƒ­ï¼‰ */
        .history-list { flex: 0.7; overflow-y: auto; background: #fff; border-radius: 8px; border: 1px solid #ddd; margin-top: 4px; }
        .h-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; text-align: center; }
        .h-table th { background: #eee; position: sticky; top: 0; padding: 6px; font-size: 0.7rem; }
        .h-table td { border-bottom: 1px solid #f0f0f0; padding: 8px; }

        /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç¢ºå®Ÿã«è¦‹ãˆã‚‹ã‚ˆã†ã«ï¼ï¼‰ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; padding: 10px; }
        .modal-content { background: #fff; width: 100%; max-width: 400px; padding: 20px; border-radius: 12px; max-height: 90vh; overflow-y: auto; position: relative; }
        
        .m-section { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .m-section h4 { margin: 0 0 10px 0; font-size: 0.9rem; color: var(--primary); }

        .sw-group { display: flex; align-items: center; justify-content: space-between; background: #f0f0f0; padding: 8px 12px; border-radius: 20px; font-size: 0.85rem; margin-bottom: 8px; }
        
        /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
        .switch { position: relative; width: 44px; height: 22px; display: inline-block; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; transition: .4s; border-radius: 22px; cursor: pointer; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        .pitch-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .pitch-table th { text-align: left; padding: 8px 0; color: #666; }
        .pitch-table td { padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        .pitch-table input[type="checkbox"] { width: 18px; height: 18px; }
    </style>
</head>
<body>

    <div class="header">
        <h1 id="title-label">æŠ•æ‰‹A vs æ‰“è€…A</h1>
        <button class="btn-settings" onclick="openModal('settings-modal')">âš™ï¸ è©¦åˆè¨­å®š</button>
    </div>

    <div class="main-layout">
        <div class="map-area">
            <div id="canvas-wrap">
                <canvas id="h-layer" width="300" height="360"></canvas>
                <div id="s-zone"></div>
            </div>
        </div>
        
        <div class="ctrl-panel">
            <div id="sp-area" class="speed-row">
                <span id="sp-val" class="speed-txt">140 km/h</span>
                <input type="range" id="sp-sld" min="80" max="170" value="140" oninput="document.getElementById('sp-val').innerText=this.value+' km/h'">
            </div>

            <div class="compass" id="comp"></div>
            
            <div class="action-row">
                <button class="btn-main b-undo" onclick="undo()">å…¥åŠ›æ¶ˆå»</button>
                <button class="btn-main b-rep" onclick="generateReport()">ãƒ¬ãƒãƒ¼ãƒˆå…±æœ‰</button>
            </div>
        </div>
        
        <div class="history-list">
            <table class="h-table">
                <thead><tr><th>#</th><th>çƒç¨®</th><th>çƒé€Ÿ</th></tr></thead>
                <tbody id="h-body"></tbody>
            </table>
        </div>
    </div>

    <div id="settings-modal" class="modal" onclick="closeModal(event, 'settings-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 style="margin: 0 0 15px 0; font-size: 1.2rem;">âš™ï¸ è¨˜éŒ²è¨­å®š</h2>

            <div class="m-section" style="background: #fff9c4; padding: 10px; border-radius: 8px;">
                <h4>â–¼ çƒé€Ÿå…¥åŠ›ã®è¨­å®š</h4>
                <div class="sw-group">
                    <span>ãƒ¡ã‚¤ãƒ³ç”»é¢ã«çƒé€Ÿã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‡ºã™</span>
                    <label class="switch"><input type="checkbox" id="sp-on" checked onchange="syncUI()"><span class="slider"></span></label>
                </div>
            </div>

            <div class="m-section">
                <h4>â–¼ é¸æ‰‹æƒ…å ±</h4>
                <input type="text" id="p-name" class="sw-group" style="width:100%; border:1px solid #ddd; background:#fff;" value="æŠ•æ‰‹A" onchange="syncUI()" placeholder="æŠ•æ‰‹å">
                <div class="sw-group"><span>å³æŠ• / å·¦æŠ•</span><label class="switch"><input type="checkbox" id="p-hand" onchange="syncUI()"><span class="slider"></span></label></div>
                
                <input type="text" id="b-name" class="sw-group" style="width:100%; border:1px solid #ddd; background:#fff; margin-top:10px" value="æ‰“è€…A" onchange="syncUI()" placeholder="æ‰“è€…å">
                <div class="sw-group"><span>å³æ‰“ / å·¦æ‰“</span><label class="switch"><input type="checkbox" id="b-side" onchange="syncUI()"><span class="slider"></span></label></div>
            </div>

            <div class="m-section">
                <h4>â–¼ çƒç¨®ãƒœã‚¿ãƒ³ãƒ»è¡¨ç¤ºè¨­å®š</h4>
                <table class="pitch-table">
                    <thead><tr><th>çƒç¨®</th><th>ãƒœã‚¿ãƒ³</th><th>ãƒãƒƒãƒ—</th></tr></thead>
                    <tbody id="pitch-config-body"></tbody>
                </table>
            </div>

            <button onclick="document.getElementById('settings-modal').style.display='none'" class="btn-main" style="width:100%; background:var(--primary); margin-top:10px;">è¨­å®šã‚’é–‰ã˜ã‚‹</button>
            <button onclick="resetAll()" style="width:100%; margin-top:20px; background:none; border:none; color:var(--danger); font-size:0.8rem; text-decoration: underline;">å…¨è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button>
        </div>
    </div>

    <div id="report-modal" class="modal" onclick="closeModal(event, 'report-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin:0">ğŸ“¸ ãƒ¬ãƒãƒ¼ãƒˆå®Œæˆ</h3>
            <img id="report-img" style="width:100%; border:1px solid #ccc; border-radius:6px; margin:10px 0;">
            <button class="btn-main" style="background:var(--share); width:100%" onclick="shareReport()">ğŸ“¤ ã‚¢ãƒ—ãƒªã§å…±æœ‰ã™ã‚‹</button>
            <button onclick="document.getElementById('report-modal').style.display='none'" class="btn-main" style="width:100%; margin-top:8px; background:#666;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        let db=[], selT='ç›´çƒ', reportBlob=null;
        const colors = {'ç›´çƒ':'#e74c3c','ã‚«ãƒ¼ãƒ–':'#3498db','ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼':'#2ecc71','ãƒ•ã‚©ãƒ¼ã‚¯':'#f39c12','ãƒã‚§ãƒ³ã‚¸':'#9b59b6','ã‚·ãƒ¥ãƒ¼ãƒˆ':'#1abc9c','ã‚·ãƒ³ã‚«ãƒ¼':'#d35400','ã‚«ãƒƒãƒˆ':'#34495e','ãƒ©ã‚¤ã‚º':'#f1c40f'};
        const pitchLayout = [{a:'â†–', r:'ã‚«ãƒƒãƒˆ', l:'ã‚·ãƒ¥ãƒ¼ãƒˆ'}, {a:'â†‘', r:'ãƒ©ã‚¤ã‚º', l:'ãƒ©ã‚¤ã‚º'}, {a:'â†—', r:'ã‚·ãƒ¥ãƒ¼ãƒˆ', l:'ã‚«ãƒƒãƒˆ'},{a:'â†', r:'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼', l:'ã‚·ãƒ³ã‚«ãƒ¼'}, {a:'â—¯', r:'ç›´çƒ', l:'ç›´çƒ'}, {a:'â†’', r:'ã‚·ãƒ³ã‚«ãƒ¼', l:'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼'},{a:'â†™', r:'ã‚«ãƒ¼ãƒ–', l:'ãƒã‚§ãƒ³ã‚¸'}, {a:'â†“', r:'ãƒ•ã‚©ãƒ¼ã‚¯', l:'ãƒ•ã‚©ãƒ¼ã‚¯'}, {a:'â†˜', r:'ãƒã‚§ãƒ³ã‚¸', l:'ã‚«ãƒ¼ãƒ–'}];
        
        let pitchConfig = {
            'ç›´çƒ': {btn: true, map: true}, 'ã‚«ãƒ¼ãƒ–': {btn: true, map: true}, 'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼': {btn: true, map: true},
            'ãƒ•ã‚©ãƒ¼ã‚¯': {btn: true, map: true}, 'ãƒã‚§ãƒ³ã‚¸': {btn: true, map: true}, 'ã‚·ãƒ¥ãƒ¼ãƒˆ': {btn: true, map: true},
            'ã‚·ãƒ³ã‚«ãƒ¼': {btn: true, map: true}, 'ã‚«ãƒƒãƒˆ': {btn: true, map: true}, 'ãƒ©ã‚¤ã‚º': {btn: true, map: true}
        };

        function initSettingsTable() {
            const body = document.getElementById('pitch-config-body');
            body.innerHTML = '';
            Object.keys(pitchConfig).forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p}</td>
                    <td><input type="checkbox" ${pitchConfig[p].btn?'checked':''} onchange="pitchConfig['${p}'].btn=this.checked; syncUI();"></td>
                    <td><input type="checkbox" ${pitchConfig[p].map?'checked':''} onchange="pitchConfig['${p}'].map=this.checked; syncUI();"></td>
                `;
                body.appendChild(tr);
            });
        }

        function syncUI() {
            const isL = document.getElementById('p-hand').checked;
            const bL = document.getElementById('b-side').checked;
            document.getElementById('title-label').innerText = `${document.getElementById('p-name').value}(${isL?'L':'R'}) vs ${document.getElementById('b-name').value}(${bL?'L':'R'})`;
            
            // çƒé€Ÿã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('sp-area').style.display = document.getElementById('sp-on').checked ? 'flex' : 'none';

            const comp = document.getElementById('comp'); 
            comp.innerHTML = '';
            pitchLayout.forEach(item => {
                const label = isL ? item.l : item.r;
                const btn = document.createElement('button');
                btn.className = `p-btn ${selT === label ? 'active' : ''} ${!pitchConfig[label].btn ? 'hidden' : ''}`;
                btn.innerHTML = `${item.a}<span>${label}</span>`;
                btn.onclick = () => { selT = label; syncUI(); };
                comp.appendChild(btn);
            });
            drawMap(); updateHistory();
        }

        const wrap = document.getElementById('canvas-wrap');
        function handleTouch(e) {
            e.preventDefault();
            const r=wrap.getBoundingClientRect(); 
            const xVal = e.touches ? e.touches[0].clientX : e.clientX;
            const yVal = e.touches ? e.touches[0].clientY : e.clientY;
            const x = Math.round(((xVal - r.left) / r.width) * 300);
            const y = Math.round(((yVal - r.top) / r.height) * 360);
            const spVal = document.getElementById('sp-on').checked ? document.getElementById('sp-sld').value + " km/h" : "-";
            db.push({t:selT, x:x, y:y, s:spVal});
            drawMap(); updateHistory();
        }
        wrap.addEventListener('touchstart', handleTouch);
        wrap.addEventListener('mousedown', handleTouch);

        function drawMap() {
            const ctx = document.getElementById('h-layer').getContext('2d'); ctx.clearRect(0,0,300,360);
            document.querySelectorAll('.dot').forEach(m=>m.remove());
            db.forEach(p => {
                if (pitchConfig[p.t] && pitchConfig[p.t].map) {
                    const m=document.createElement('div'); m.className='dot'; m.style.left=(p.x/300*100)+'%'; m.style.top=(p.y/360*100)+'%'; m.style.background=colors[p.t]; wrap.appendChild(m);
                }
            });
        }

        function updateHistory() {
            const body = document.getElementById('h-body');
            body.innerHTML = db.length === 0 ? '<tr><td colspan="3" style="padding:15px;color:#999">ã‚¾ãƒ¼ãƒ³ã‚’ã‚¿ãƒƒãƒã—ã¦è¨˜éŒ²</td></tr>' : '';
            [...db].reverse().forEach((p, i) => {
                const row = body.insertRow();
                row.innerHTML = `<td>${db.length-i}</td><td>${p.t}</td><td>${p.s}</td>`;
            });
        }

        function undo() { if(db.length > 0) { db.pop(); drawMap(); updateHistory(); } }

        async function generateReport() {
            if(db.length === 0) return alert("è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“");
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = 600; canvas.height = 800;
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,600,800);
            ctx.fillStyle = "#0a2e5c"; ctx.fillRect(0,0,600,80);
            ctx.fillStyle = "#fff"; ctx.font = "bold 24px sans-serif"; ctx.fillText("PITCHING REPORT", 30, 50);
            ctx.save(); ctx.translate(30, 160); ctx.fillStyle = "#222"; ctx.fillRect(0,0,300,360);
            ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.strokeRect(300*0.21, 360*0.22, 300*0.58, 360*0.56);
            db.forEach(p => { if (pitchConfig[p.t].map) {
                ctx.fillStyle = colors[p.t]; ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle="#fff"; ctx.stroke(); 
            }}); ctx.restore();
            ctx.fillStyle = "#000"; ctx.font = "bold 18px sans-serif"; ctx.fillText("ã€Historyã€‘", 350, 180);
            db.slice(-15).reverse().forEach((p,i) => { ctx.font = "14px sans-serif"; ctx.fillText(`${db.length-i}. ${p.t} (${p.s})`, 350, 210+(i*24)); });
            document.getElementById('report-img').src = canvas.toDataURL();
            canvas.toBlob(b => reportBlob = b);
            openModal('report-modal');
        }

        async function shareReport() {
            if (!reportBlob) return;
            const file = new File([reportBlob], "report.png", { type: "image/png" });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file], title: 'æŠ•çƒãƒ¬ãƒãƒ¼ãƒˆ' });
            }
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(e, id) { if(e.target.id === id) document.getElementById(id).style.display = 'none'; }
        function resetAll() { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { db = []; drawMap(); syncUI(); } }
        
        initSettingsTable();
        syncUI();
    </script>
</body>
</html>
