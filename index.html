<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Scout - Speed Master | htmlãƒãƒ³</title>
    <style>
        :root { --primary: #0a2e5c; --accent: #e63946; --bg: #f0f2f5; --undo: #f39c12; --success: #2b9348; --danger: #d90429; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        body { margin: 0; padding: 5px; height: 100vh; width: 100vw; overflow: hidden; background: var(--bg); display: flex; flex-direction: column; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 10px; border-radius: 8px; margin-bottom: 5px; }
        .header h1 { font-size: 0.9rem; margin: 0; }
        .btn-settings { background: #fff; border: none; color: var(--primary); padding: 5px 12px; border-radius: 5px; font-weight: bold; font-size: 0.8rem; }

        .main-layout { flex: 1; display: flex; flex-direction: column; min-height: 0; gap: 5px; }

        /* ã‚¾ãƒ¼ãƒ³ãƒãƒƒãƒ— */
        .map-area { flex: 1.5; display: flex; justify-content: center; align-items: center; position: relative; min-height: 0; }
        #canvas-wrap { position: relative; height: 100%; aspect-ratio: 3 / 3.6; background: #333; border: 3px solid #111; border-radius: 10px; touch-action: none; }
        #s-zone { position: absolute; top: 22%; left: 21%; width: 58%; height: 56%; border: 1.5px solid rgba(255,255,255,0.4); pointer-events: none; }
        canvas#h-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .dot { position: absolute; width: 14px; height: 14px; border-radius: 50%; transform: translate(-50%, -50%); border: 1.5px solid #fff; pointer-events: none; z-index: 5; }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        .ctrl-panel { flex: 0 0 auto; background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* çƒé€Ÿå…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆã“ã“ã‚’å¼·åŒ–ï¼‰ */
        .speed-input-box { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; background: #fffde7; padding: 10px; border-radius: 8px; border: 2px solid #fbc02d; }
        .speed-info { display: flex; justify-content: space-between; align-items: center; }
        .speed-label { font-size: 0.8rem; font-weight: bold; color: #555; }
        .speed-display { font-size: 1.4rem; font-weight: bold; color: var(--accent); }
        #sp-sld { width: 100%; height: 35px; margin: 5px 0; }

        /* çƒç¨®ãƒœã‚¿ãƒ³ï¼ˆã‚°ãƒªãƒƒãƒ‰å›ºå®šï¼‰ */
        .compass { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .p-btn { width: 100%; aspect-ratio: 1.8/1; border: 2px solid #ddd; border-radius: 8px; background: #fff; font-size: 0.95rem; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; }
        .p-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .p-btn.hidden { visibility: hidden; pointer-events: none; }
        .p-btn span { font-size: 0.55rem; margin-top: 2px; }

        /* ä¸‹éƒ¨ãƒœã‚¿ãƒ³ */
        .action-row { display: grid; grid-template-columns: 1fr 2fr; gap: 8px; margin-top: 10px; }
        .btn-main { padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: #fff; font-size: 1rem; text-align: center; }
        .b-undo { background: var(--undo); }
        .b-rep { background: var(--success); }

        /* å±¥æ­´ï¼ˆãƒ¢ãƒã‚¯ãƒ­ãƒ»çµ¶å¯¾è‰²ãªã—ï¼‰ */
        .history-container { flex: 0.8; overflow-y: auto; background: #fff; border-radius: 8px; border: 1px solid #ddd; margin-top: 5px; }
        .h-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; text-align: center; }
        .h-table th { background: #f0f0f0; position: sticky; top: 0; padding: 8px; font-size: 0.75rem; border-bottom: 2px solid #ddd; }
        .h-table td { border-bottom: 1px solid #eee; padding: 10px; color: #333; }

        /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background: #fff; width: 100%; max-width: 400px; padding: 20px; border-radius: 15px; max-height: 90vh; overflow-y: auto; }
        .m-title { margin: 0 0 15px 0; border-bottom: 2px solid var(--primary); padding-bottom: 5px; }
        .sw-group { display: flex; align-items: center; justify-content: space-between; background: #f5f5f5; padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 0.9rem; }
        
        /* ã‚¹ã‚¤ãƒƒãƒãƒ‡ã‚¶ã‚¤ãƒ³ */
        .switch { position: relative; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        .pitch-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .pitch-table th { text-align: left; padding: 5px; font-size: 0.8rem; color: #666; }
        .pitch-table td { padding: 8px 5px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="header">
        <h1 id="title-display">æŠ•æ‰‹A vs æ‰“è€…A</h1>
        <button class="btn-settings" onclick="openModal('settings-modal')">âš™ï¸ è¨­å®š</button>
    </div>

    <div class="main-layout">
        <div class="map-area">
            <div id="canvas-wrap">
                <canvas id="h-layer" width="300" height="360"></canvas>
                <div id="s-zone"></div>
            </div>
        </div>
        
        <div class="ctrl-panel">
            <div id="sp-container" class="speed-input-box">
                <div class="speed-info">
                    <span class="speed-label">ç¾åœ¨ã®çƒé€Ÿè¨­å®š:</span>
                    <span id="sp-val" class="speed-display">140 km/h</span>
                </div>
                <input type="range" id="sp-sld" min="80" max="170" value="140" oninput="updateSpeedDisp(this.value)">
            </div>

            <div class="compass" id="pitch-grid"></div>
            
            <div class="action-row">
                <button class="btn-main b-undo" onclick="undoLast()">1æ‰“æ¶ˆå»</button>
                <button class="btn-main b-rep" onclick="showReport()">ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ</button>
            </div>
        </div>
        
        <div class="history-container">
            <table class="h-table">
                <thead><tr><th>#</th><th>çƒç¨®</th><th>çƒé€Ÿ</th></tr></thead>
                <tbody id="h-body"></tbody>
            </table>
        </div>
    </div>

    <div id="settings-modal" class="modal" onclick="closeModal(event, 'settings-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="m-title">âš™ï¸ è¨˜éŒ²è¨­å®š</h2>
            
            <div class="sw-group" style="background: #e3f2fd;">
                <span>çƒé€Ÿå…¥åŠ›ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
                <label class="switch"><input type="checkbox" id="sp-enable" checked onchange="toggleSpeedUI()"><span class="slider"></span></label>
            </div>

            <div style="margin-bottom: 15px;">
                <input type="text" id="p-name" class="sw-group" style="width:100%; border:1px solid #ddd;" value="æŠ•æ‰‹A" onchange="syncPlayerInfo()" placeholder="æŠ•æ‰‹å">
                <div class="sw-group"><span>å³æŠ• / å·¦æŠ•</span><label class="switch"><input type="checkbox" id="p-hand" onchange="syncPlayerInfo()"><span class="slider"></span></label></div>
                
                <input type="text" id="b-name" class="sw-group" style="width:100%; border:1px solid #ddd; margin-top:8px" value="æ‰“è€…A" onchange="syncPlayerInfo()" placeholder="æ‰“è€…å">
                <div class="sw-group"><span>å³æ‰“ / å·¦æ‰“</span><label class="switch"><input type="checkbox" id="b-side" onchange="syncPlayerInfo()"><span class="slider"></span></label></div>
            </div>

            <h4 style="margin: 10px 0 5px 0;">çƒç¨®ãƒ»è¡¨ç¤ºè¨­å®š</h4>
            <table class="pitch-table">
                <thead><tr><th>çƒç¨®</th><th>ãƒœã‚¿ãƒ³</th><th>ãƒãƒƒãƒ—</th></tr></thead>
                <tbody id="pitch-config-list"></tbody>
            </table>

            <button onclick="document.getElementById('settings-modal').style.display='none'" class="btn-main" style="width:100%; background:var(--primary); margin-top:15px;">å®Œäº†</button>
            <button onclick="resetData()" style="width:100%; margin-top:20px; background:none; border:none; color:var(--danger); text-decoration: underline; font-size: 0.8rem;">ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤</button>
        </div>
    </div>

    <div id="report-modal" class="modal" onclick="closeModal(event, 'report-modal')">
        <div class="modal-content">
            <h3>ğŸ“¸ ãƒ¬ãƒãƒ¼ãƒˆ</h3>
            <img id="report-img" style="width:100%; border:1px solid #ccc; border-radius:5px;">
            <button class="btn-main" style="background:var(--success); width:100%; margin-top:10px" onclick="shareImg()">å…±æœ‰ã™ã‚‹</button>
            <button onclick="document.getElementById('report-modal').style.display='none'" class="btn-main" style="width:100%; margin-top:10px; background:#666;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        let db = [], selectedPitch = 'ç›´çƒ', reportBlob = null;
        const pitchColors = {'ç›´çƒ':'#e74c3c','ã‚«ãƒ¼ãƒ–':'#3498db','ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼':'#2ecc71','ãƒ•ã‚©ãƒ¼ã‚¯':'#f39c12','ãƒã‚§ãƒ³ã‚¸':'#9b59b6','ã‚·ãƒ¥ãƒ¼ãƒˆ':'#1abc9c','ã‚·ãƒ³ã‚«ãƒ¼':'#d35400','ã‚«ãƒƒãƒˆ':'#34495e','ãƒ©ã‚¤ã‚º':'#f1c40f'};
        const pitchLayout = [{a:'â†–', r:'ã‚«ãƒƒãƒˆ', l:'ã‚·ãƒ¥ãƒ¼ãƒˆ'}, {a:'â†‘', r:'ãƒ©ã‚¤ã‚º', l:'ãƒ©ã‚¤ã‚º'}, {a:'â†—', r:'ã‚·ãƒ¥ãƒ¼ãƒˆ', l:'ã‚«ãƒƒãƒˆ'},{a:'â†', r:'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼', l:'ã‚·ãƒ³ã‚«ãƒ¼'}, {a:'â—¯', r:'ç›´çƒ', l:'ç›´çƒ'}, {a:'â†’', r:'ã‚·ãƒ³ã‚«ãƒ¼', l:'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼'},{a:'â†™', r:'ã‚«ãƒ¼ãƒ–', l:'ãƒã‚§ãƒ³ã‚¸'}, {a:'â†“', r:'ãƒ•ã‚©ãƒ¼ã‚¯', l:'ãƒ•ã‚©ãƒ¼ã‚¯'}, {a:'â†˜', r:'ãƒã‚§ãƒ³ã‚¸', l:'ã‚«ãƒ¼ãƒ–'}];
        
        let config = {
            'ç›´çƒ': {btn: true, map: true}, 'ã‚«ãƒ¼ãƒ–': {btn: true, map: true}, 'ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼': {btn: true, map: true},
            'ãƒ•ã‚©ãƒ¼ã‚¯': {btn: true, map: true}, 'ãƒã‚§ãƒ³ã‚¸': {btn: true, map: true}, 'ã‚·ãƒ¥ãƒ¼ãƒˆ': {btn: true, map: true},
            'ã‚·ãƒ³ã‚«ãƒ¼': {btn: true, map: true}, 'ã‚«ãƒƒãƒˆ': {btn: true, map: true}, 'ãƒ©ã‚¤ã‚º': {btn: true, map: true}
        };

        // çƒé€Ÿè¡¨ç¤ºã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
        function updateSpeedDisp(val) {
            document.getElementById('sp-val').innerText = val + " km/h";
        }

        function toggleSpeedUI() {
            const isEnabled = document.getElementById('sp-enable').checked;
            document.getElementById('sp-container').style.display = isEnabled ? 'flex' : 'none';
        }

        function initSettings() {
            const list = document.getElementById('pitch-config-list');
            list.innerHTML = '';
            Object.keys(config).forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p}</td>
                    <td><input type="checkbox" ${config[p].btn?'checked':''} onchange="config['${p}'].btn=this.checked; updateUI();"></td>
                    <td><input type="checkbox" ${config[p].map?'checked':''} onchange="config['${p}'].map=this.checked; updateUI();"></td>
                `;
                list.appendChild(tr);
            });
        }

        function updateUI() {
            const isL = document.getElementById('p-hand').checked;
            const bL = document.getElementById('b-side').checked;
            document.getElementById('title-display').innerText = `${document.getElementById('p-name').value}(${isL?'L':'R'}) vs ${document.getElementById('b-name').value}(${bL?'L':'R'})`;
            
            const grid = document.getElementById('pitch-grid'); 
            grid.innerHTML = '';
            pitchLayout.forEach(item => {
                const name = isL ? item.l : item.r;
                const btn = document.createElement('button');
                btn.className = `p-btn ${selectedPitch === name ? 'active' : ''} ${!config[name].btn ? 'hidden' : ''}`;
                btn.innerHTML = `${item.a}<span>${name}</span>`;
                btn.onclick = () => { selectedPitch = name; updateUI(); };
                grid.appendChild(btn);
            });
            drawDots(); 
            refreshHistory();
        }

        const wrap = document.getElementById('canvas-wrap');
        function recordPitch(e) {
            e.preventDefault();
            const rect = wrap.getBoundingClientRect(); 
            const xVal = e.touches ? e.touches[0].clientX : e.clientX;
            const yVal = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = Math.round(((xVal - rect.left) / rect.width) * 300);
            const y = Math.round(((yVal - rect.top) / rect.height) * 360);
            
            // ç¢ºå®Ÿã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‹ã‚‰ç¾åœ¨ã®å€¤ã‚’å–å¾—
            const speedNow = document.getElementById('sp-enable').checked ? document.getElementById('sp-sld').value + " km/h" : "-";
            
            db.push({t: selectedPitch, x: x, y: y, s: speedNow});
            drawDots(); 
            refreshHistory();
        }
        wrap.addEventListener('touchstart', recordPitch);
        wrap.addEventListener('mousedown', recordPitch);

        function drawDots() {
            const ctx = document.getElementById('h-layer').getContext('2d'); 
            ctx.clearRect(0,0,300,360);
            document.querySelectorAll('.dot').forEach(d => d.remove());
            db.forEach(p => {
                if (config[p.t] && config[p.t].map) {
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    dot.style.left = (p.x / 300 * 100) + '%';
                    dot.style.top = (p.y / 360 * 100) + '%';
                    dot.style.background = pitchColors[p.t];
                    wrap.appendChild(dot);
                }
            });
        }

        function refreshHistory() {
            const body = document.getElementById('h-body');
            body.innerHTML = db.length === 0 ? '<tr><td colspan="3" style="padding:20px; color:#999;">ã‚¾ãƒ¼ãƒ³ã‚’è§¦ã£ã¦è¨˜éŒ²é–‹å§‹</td></tr>' : '';
            [...db].reverse().forEach((p, i) => {
                const row = body.insertRow();
                // å±¥æ­´ã¯çµ¶å¯¾ã«è‰²ã‚’ã¤ã‘ãªã„
                row.innerHTML = `<td>${db.length-i}</td><td>${p.t}</td><td>${p.s}</td>`;
            });
        }

        function undoLast() { if(db.length > 0) { db.pop(); drawDots(); refreshHistory(); } }

        function syncPlayerInfo() { updateUI(); }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(e, id) { if(e.target.id === id) document.getElementById(id).style.display = 'none'; }
        function resetData() { if(confirm("å…¨è¨˜éŒ²ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { db = []; drawDots(); updateUI(); } }

        // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        async function showReport() {
            if(db.length === 0) return alert("è¨˜éŒ²ãªã—");
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = 600; canvas.height = 800;
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,600,800);
            ctx.fillStyle = "#0a2e5c"; ctx.fillRect(0,0,600,70);
            ctx.fillStyle = "#fff"; ctx.font = "bold 24px sans-serif"; ctx.fillText("PITCHING REPORT", 30, 45);
            ctx.save(); ctx.translate(30, 140); ctx.fillStyle = "#222"; ctx.fillRect(0,0,300,360);
            ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.strokeRect(300*0.21, 360*0.22, 300*0.58, 360*0.56);
            db.forEach(p => { if (config[p.t].map) {
                ctx.fillStyle = pitchColors[p.t]; ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle="#fff"; ctx.stroke(); 
            }}); ctx.restore();
            ctx.fillStyle = "#333"; ctx.font = "bold 18px sans-serif"; ctx.fillText("ã€Historyã€‘", 350, 140);
            db.slice(-20).reverse().forEach((p,i) => { ctx.font = "14px sans-serif"; ctx.fillText(`${db.length-i}. ${p.t} (${p.s})`, 350, 170+(i*22)); });
            document.getElementById('report-img').src = canvas.toDataURL();
            canvas.toBlob(b => reportBlob = b);
            openModal('report-modal');
        }

        async function shareImg() {
            if (!reportBlob) return;
            const file = new File([reportBlob], "report.png", { type: "image/png" });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file], title: 'æŠ•çƒãƒ¬ãƒãƒ¼ãƒˆ' });
            } else { alert("ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„"); }
        }

        initSettings();
        updateUI();
    </script>
</body>
</html>
